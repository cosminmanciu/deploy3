# WHMCS Docker Bundle - Complete Deployment Guide

This is a **self-contained WHMCS deployment bundle** generated by the WHMCS Tower system. This README provides comprehensive documentation about the bundle architecture, structure, and how to use it.

## ğŸ—ï¸ Bundle Architecture Overview

This bundle contains everything needed to deploy a specific WHMCS build with all its packages, configurations, and dependencies in a Docker environment. It's designed to be:

- **Self-contained**: All configuration files, packages, and scripts included
- **Kubernetes-ready**: No external volume dependencies for production
- **Development-friendly**: Optional external mounts for live editing
- **Zero-configuration**: Automatic port allocation and setup
- **Email Testing**: MailPit integration for development environments

## ğŸ“ Bundle Structure

```
whmcs-bundle/
â”œâ”€â”€ ğŸ“„ README.md                     # This comprehensive guide
â”œâ”€â”€ ğŸ“„ settings.json                 # Build configuration and package definitions
â”œâ”€â”€ ğŸ“„ .env                          # Environment variables (auto-generated)
â”œâ”€â”€ ğŸ“„ docker-compose.yml            # Environment-specific Docker Compose (auto-generated)
â”œâ”€â”€ ğŸ“„ Dockerfile                    # Multi-stage Docker build definition
â”œâ”€â”€ ğŸ“„ setup.sh                      # First-run setup script
â”œâ”€â”€ ğŸ“„ whmcs.sh                     # Control script for container management
â”œâ”€â”€ 
â”œâ”€â”€ ğŸ“‚ app/                          # Application files (DEVELOPMENT ONLY)
â”‚   â”‚                               # Contains all WHMCS files for real-time editing
â”‚   â”‚                               # Only present in development bundles
â”‚   â”œâ”€â”€ ğŸ“„ composer.json            # WHMCS core + package dependencies
â”‚   â”œâ”€â”€ ğŸ“„ auth.json                # Packeton repository credentials  
â”‚   â”œâ”€â”€ ğŸ“„ .env                     # Application environment variables
â”‚   â”œâ”€â”€ ğŸ“„ index.php                # WHMCS entry point
â”‚   â”œâ”€â”€ ğŸ“‚ modules/                 # WHMCS modules
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ addons/              # Addon modules
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ servers/             # Server modules  
â”‚   â”‚   â””â”€â”€ ğŸ“‚ gateways/            # Payment gateway modules
â”‚   â”œâ”€â”€ ğŸ“‚ templates/               # WHMCS themes
â”‚   â””â”€â”€ ğŸ“‚ vendor/                  # Composer dependencies
â”‚
â”œâ”€â”€ ğŸ“‚ scripts/                     # Migration and startup scripts
â”‚   â”œâ”€â”€ ğŸ“„ *.sql                   # Database scripts (imported to MySQL)
â”‚   â”œâ”€â”€ ğŸ“„ *.sh                    # Shell scripts (executed in container)
â”‚   â””â”€â”€ ğŸ“„ *.php                   # PHP scripts (executed via PHP CLI)
â”‚
â””â”€â”€ ğŸ“‚ config/                      # Container configuration
    â”œâ”€â”€ ğŸ“‚ docker/
    â”‚   â””â”€â”€ ğŸ“„ healthcheck.php      # Container health monitoring
    â”œâ”€â”€ ğŸ“‚ mysql/
    â”‚   â””â”€â”€ ğŸ“„ my.cnf              # MySQL configuration
    â”œâ”€â”€ ğŸ“‚ php/
    â”‚   â”œâ”€â”€ ğŸ“„ php.ini             # Main PHP configuration
    â”‚   â””â”€â”€ ğŸ“„ whmcs-settings.ini  # WHMCS-specific PHP settings
    â”œâ”€â”€ ğŸ“‚ supervisor/
    â”‚   â””â”€â”€ ğŸ“„ supervisord.conf    # Process supervision configuration
    â””â”€â”€ ğŸ“‚ whmcs/
        â””â”€â”€ ğŸ“„ configuration.php   # WHMCS configuration template
```

## ğŸš€ Quick Start

### 1. **Extract and Navigate**
```bash
unzip whmcs-bundle-*.zip
cd whmcs-bundle-*
```

### 2. **Start WHMCS**
```bash
./whmcs.sh start
```

### 3. **Access WHMCS**
The script will automatically:
- Allocate free ports starting from 20080 (WHMCS) and 23306 (Database)
- Display the access URL in the output
- Set up the database and install dependencies
- Configure environment-specific mounting

Example output:
```
âœ… Allocated ports: WHMCS=20080, Database=23306
ğŸŒ WHMCS is starting. Access it at http://localhost:20080
```

## ğŸ—ï¸ Environment-Specific Behavior

This bundle automatically configures itself based on the build environment:

### **Development Environment**
- **Real-time editing**: Files in `app/` are directly mounted into the container
- **Immediate changes**: Edits are reflected instantly without rebuilding  
- **No docker volumes**: All files accessible on host for easy development
- **Full source access**: Complete WHMCS source + packages included
- **Usage**: Edit files in `app/` directory for live development

### **Staging/Production Environment**  
- **Self-contained**: Uses docker volumes for complete isolation
- **No external folders**: No `app/` directory included in bundle
- **No host dependencies**: All files contained within docker infrastructure
- **Kubernetes-ready**: Perfect for container orchestration

The environment is automatically detected from your build configuration.

## ğŸ“‹ Available Commands

The `whmcs.sh` control script provides comprehensive container management:

```bash
# Container Management
./whmcs.sh start               # Start WHMCS containers
./whmcs.sh stop                # Stop containers
./whmcs.sh restart             # Restart containers
./whmcs.sh status              # Show container status

# Monitoring & Debugging
./whmcs.sh logs                # View container logs
./whmcs.sh shell               # Access WHMCS container shell
./whmcs.sh db-shell            # Access MySQL shell

# Additional Tools
./whmcs.sh import-scripts      # Import scripts from tower-scripts/
./whmcs.sh configure-mailpit  # Configure WHMCS to use MailPit (dev only)
./whmcs.sh help                # Show detailed help
```

## ğŸ“§ MailPit Email Testing (Development Only)

For development environments, this bundle includes **MailPit** - a lightweight email testing tool that captures all outgoing emails without actually sending them.

### Features:
- **Email Capture**: All emails sent by WHMCS are captured locally
- **Web Interface**: View and inspect emails via web UI
- **No External Dependencies**: Runs entirely within Docker
- **Zero Configuration**: Automatically configured for development builds

### Access Points:
- **Web UI**: http://localhost:21025
- **SMTP Server**: mailpit:1025 (internal to Docker network)

### Usage:
1. Start the containers: `./whmcs.sh start`
2. Configure WHMCS: `./whmcs.sh configure-mailpit`
3. Access MailPit UI: http://localhost:21025
4. All emails sent from WHMCS will appear in the MailPit interface

### Configuration Details:
- **SMTP Host**: mailpit
- **SMTP Port**: 1025
- **Authentication**: None required
- **Security**: None (suitable for development only)

**Note**: MailPit is only included in development environment builds. Production and staging environments should use proper SMTP configuration.

## âš™ï¸ Configuration Files Explained

### `settings.json` - Bundle Configuration
**Purpose**: Contains all build metadata, package definitions, and deployment settings.

**Key Sections**:
```json
{
  "build": {
    "uuid": "build-uuid",
    "version": 1
  },
  "deployment": {
    "uuid": "deployment-uuid",
    "type": "docker_compose"
  },
  "whmcs": {
    "version": "8.11.2",
    "admin_uri": "admin",
    "php_version": "8.1"
  },
  "packages": [
    {
      "name": "whmcs/vanilla-8.11.2",
      "type": "whmcs-core",
      "location": "/",
      "version": "latest"
    }
  ]
}
```

### `composer.json` - Dependencies
**Purpose**: Defines WHMCS core package and all additional packages.

**Structure**:
- **WHMCS Core**: `whmcs/vanilla-{version}` - Main WHMCS files
- **Packages**: Addons, modules, gateways from your build
- **Authentication**: Configured for private Packeton repository

### `setup.sh` - First-Run Setup
**Purpose**: Executed automatically on first container start.

**What it does**:
1. **Environment Setup**: Configures PHP, Apache, and system settings
2. **Composer Install**: Downloads and installs all packages
3. **Package Organization**: 
   - Copies WHMCS core files to document root
   - Places addons in `/modules/addons/`
   - Places servers in `/modules/servers/`
   - Places gateways in `/modules/gateways/`
4. **File Permissions**: Sets correct ownership and permissions
5. **Health Check**: Validates installation

### `.env` - Environment Variables
**Purpose**: Runtime configuration for Docker containers.

**Auto-Generated Values**:
```bash
# Build Information
BUILD_UUID=12345678-1234-1234-1234-123456789012
BUILD_VERSION=1
DEPLOYMENT_UUID=87654321-4321-4321-4321-210987654321

# WHMCS Configuration  
WHMCS_VERSION=8.11.2
PHP_VERSION=8.1
ADMIN_URI=admin
ENVIRONMENT=production

# Container Settings
CONTAINER_NAME=whmcs-12345678-v1
HOST_PORT=20080                # Auto-allocated safe port
DB_PORT=23306                  # Auto-allocated database port

# Database Configuration
DB_HOST=db
DB_NAME=whmcs
DB_USER=whmcs
DB_PASSWORD=whmcs_password
```

## ğŸ”§ Advanced Configuration

### Development Mode
Enable live code editing with external mounts:

```bash
# Copy development override
cp docker-compose.override.yml.example docker-compose.override.yml

# Start with development features
./whmcs.sh start
```

**Development Features**:
- External access: `./whmcs-files/` contains a synced copy of `/var/www/html`
- Live code inspection and backup access
- Development-specific PHP settings
- Automatic sync during container setup

### Port Configuration
**Automatic Allocation**: The system automatically finds free ports starting from:
- **WHMCS**: 20080, 20081, 20082...
- **Database**: 23306, 23307, 23308...

**Manual Override**: Edit `.env` file:
```bash
HOST_PORT=25000
DB_PORT=25001
```

### Kubernetes Deployment
The bundle is self-contained and Kubernetes-ready:

1. **Build Image**:
```bash
docker build -t whmcs-app .
```

2. **Deploy to Kubernetes**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whmcs-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: whmcs
  template:
    metadata:
      labels:
        app: whmcs
    spec:
      containers:
      - name: whmcs
        image: whmcs-app
        ports:
        - containerPort: 80
```

## ğŸ“¦ Package Management

### WHMCS Core Package
- **Package**: `whmcs/vanilla-{version}`
- **Location**: Document root (`/var/www/html/`)
- **Contains**: Core WHMCS files, templates, language files

### Addon Packages
- **Location**: `/modules/addons/`
- **Type**: WHMCS addon modules
- **Auto-detected**: Based on package type in settings.json

### Server Packages  
- **Location**: `/modules/servers/`
- **Type**: Server provisioning modules
- **Examples**: cPanel, DirectAdmin, VPS providers

### Gateway Packages
- **Location**: `/modules/gateways/`
- **Type**: Payment processing modules
- **Examples**: PayPal, Stripe, bank transfers

### Custom Scripts
- **Location**: `/scripts/`
- **Execution**: Automatic on container startup + manual via `./whmcs.sh import-scripts`
- **Order**: Alphabetical by filename
- **Types**: 
  - `.sql` - Imported to MySQL database
  - `.sh` - Executed as shell scripts in container
  - `.php` - Executed via PHP CLI

## ğŸ” Troubleshooting

### Container Won't Start
```bash
# Check container status
./whmcs.sh status

# View detailed logs
./whmcs.sh logs

# Check port availability
netstat -tlnp | grep 20080
```

### Database Connection Issues
```bash
# Access database shell
./whmcs.sh db-shell

# Check database variables
SHOW VARIABLES LIKE 'port';
```

### Permission Issues
```bash
# Access container shell
./whmcs.sh shell

# Check file permissions
ls -la /var/www/html/
chown -R www-data:www-data /var/www/html/
```

### Package Installation Problems
```bash
# Re-run setup script
./whmcs.sh shell
/usr/local/bin/setup.sh

# Check composer logs
composer install --verbose
```

## ğŸ›¡ï¸ Security Considerations

### Port Security
- **Safe Range**: Ports 20000+ avoid browser security restrictions
- **Firewall**: Only expose necessary ports
- **Production**: Use reverse proxy (nginx, Apache)

### Database Security
- **Passwords**: Change default database passwords
- **Network**: Restrict database access to WHMCS container only
- **Backup**: Regular database backups

### File Permissions
- **Web Files**: `www-data:www-data` ownership
- **Sensitive Files**: Restricted access to config files
- **Logs**: Proper log rotation and access controls

## ğŸ“š Additional Resources

### WHMCS Documentation
- [WHMCS Official Docs](https://docs.whmcs.com/)
- [System Requirements](https://docs.whmcs.com/System_Requirements)
- [Installation Guide](https://docs.whmcs.com/Installing_WHMCS)

### Docker Resources
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [Dockerfile Best Practices](https://docs.docker.com/develop/dev-best-practices/)

### Support
For bundle-specific issues:
1. Check this README
2. Review container logs: `./whmcs.sh logs`
3. Access shell for debugging: `./whmcs.sh shell`
4. Contact your WHMCS Tower administrator

---

## ğŸ“ Bundle Information

**Generated**: 2025-09-15 07:45:37 UTC  
**WHMCS Version**: 8.6.2  
**PHP Version**: 7.4.*  
**Environment**: staging  
**Build UUID**: 01994c56-0894-738d-bc9a-4d94ce9ea277  
**Deployment UUID**: 01994c56-1e07-71e4-866e-4373ed530da2

This bundle was automatically generated by the WHMCS Tower system and contains all necessary components for a complete WHMCS deployment.
